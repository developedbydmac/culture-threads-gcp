name: Node.js Application CI/CD

on:
  push:
    branches: [master, main]
    paths:
      - 'app/**'
      - 'k8s/**'
      - '.github/workflows/application.yml'
  pull_request:
    branches: [master, main]
    paths:
      - 'app/**'
      - 'k8s/**'

env:
  PROJECT_ID: 'culture-threads-prod'
  REGION: 'us-central1'
  GAR_LOCATION: 'us-central1'
  REPOSITORY: 'culture-threads'
  IMAGE: 'culture-threads-api'
  CLUSTER_NAME: 'culture-threads-cluster'
  CLUSTER_ZONE: 'us-central1-a'

jobs:
  test:
    name: ðŸ§ª Test Application
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: âš™ï¸ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'app/package-lock.json'

      - name: ðŸ“¥ Install Dependencies
        run: |
          cd app
          npm ci

      - name: ðŸ§ª Run Tests
        run: |
          cd app
          npm test

      - name: ðŸ” Security Scan - Filesystem
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './app'
          format: 'sarif'
          output: 'trivy-fs-results.sarif'
        continue-on-error: true

      - name: ðŸ“Š Upload Filesystem Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-fs-results.sarif'

  build-and-push:
    name: ðŸ—ï¸ Build & Push Container
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    
    permissions:
      contents: read
      id-token: write

    steps:
      - name: ðŸ“¦ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ”‘ Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ” Configure Docker for GAR
        run: gcloud auth configure-docker ${{ env.GAR_LOCATION }}-docker.pkg.dev

      - name: ðŸ·ï¸ Generate Image Tags
        id: meta
        run: |
          SHORT_SHA=${GITHUB_SHA::8}
          IMAGE_URI="${{ env.GAR_LOCATION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE }}"
          echo "IMAGE_TAG=${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_OUTPUT
          echo "FULL_IMAGE=${IMAGE_URI}:${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "LATEST_IMAGE=${IMAGE_URI}:latest" >> $GITHUB_OUTPUT

      - name: ðŸ—ï¸ Build and Push Image
        run: |
          cd app
          docker build -t ${{ steps.meta.outputs.FULL_IMAGE }} .
          docker tag ${{ steps.meta.outputs.FULL_IMAGE }} ${{ steps.meta.outputs.LATEST_IMAGE }}
          docker push ${{ steps.meta.outputs.FULL_IMAGE }}
          docker push ${{ steps.meta.outputs.LATEST_IMAGE }}

      - name: ðŸ” Security Scan - Container Image
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ steps.meta.outputs.LATEST_IMAGE }}
          format: 'sarif'
          output: 'trivy-image-results.sarif'

      - name: ðŸ“Š Upload Image Scan Results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-image-results.sarif'

      - name: ï¿½ Deploy to GKE
        run: |
          # Get GKE credentials
          gcloud container clusters get-credentials ${{ env.CLUSTER_NAME }} --zone ${{ env.CLUSTER_ZONE }}
          
          # Update image in deployment manifest
          sed -i "s|image: gcr.io/culture-threads-prod/culture-threads-api:latest|image: ${{ steps.meta.outputs.FULL_IMAGE }}|g" k8s/apps/deployment.yaml
          
          # Apply manifests
          kubectl apply -f k8s/apps/
          
          # Wait for rollout
          kubectl rollout status deployment/culture-threads-api -n culture-threads --timeout=600s
          
          # Verify deployment
          kubectl get pods -n culture-threads -l app=culture-threads-api

      - name: ðŸ“ Deployment Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Image**: ${{ steps.meta.outputs.FULL_IMAGE }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cluster**: ${{ env.CLUSTER_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Namespace**: culture-threads" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Successfully deployed" >> $GITHUB_STEP_SUMMARY
